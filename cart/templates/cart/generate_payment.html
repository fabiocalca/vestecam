{% extends 'base.html' %}

{% block title %}
Pagamento
{% endblock %}

{% block content %}
<h1>Valor total: {{ cart.summary }} </h1>
<div id="cardPaymentBrick_container"></div>
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
  const mp = new MercadoPago('APP_USR-702a3f1e-d268-4e3b-8a2a-6887dfd34a91');
  const bricksBuilder = mp.bricks();
  const renderCardPaymentBrick = async (bricksBuilder) => {
    const settings = {
      initialization: {
        amount: 1.0, // valor total a ser pago
      },
      callbacks: {
        onReady: () => {
          /*
            Callback chamado quando o Brick estiver pronto.
            Aqui você pode ocultar loadings do seu site, por exemplo.
          */
        },
        onSubmit: (cardFormData) => {
          // callback chamado o usuário clicar no botão de submissão dos dados

          // ejemplo de envío de los datos recolectados por el Brick a su servidor
          return new Promise((resolve, reject) => {
              fetch("/process_payment", { 
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                  },
                  body: JSON.stringify(cardFormData)
              })
              .then((response) => {
                  // receber o resultado do pagamento
                  resolve();
              })
              .catch((error) => {
                  // lidar com a resposta de erro ao tentar criar o pagamento
                  reject();
              })
            });
        },
        onError: (error) => { 
          // callback chamado para todos os casos de erro do Brick
          console.error(error);
        },
      },
    };
    const cardPaymentBrickController = await bricksBuilder.create('cardPayment', 'cardPaymentBrick_container', settings);
    };
  renderCardPaymentBrick(bricksBuilder);
</script>
{% endblock %}